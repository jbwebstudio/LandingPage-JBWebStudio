import{DOM,Events}from"./utils.js";import{AnimationUtils}from"./animations.js";const NAV_CONFIG={scrollOffset:80,scrollDuration:800,mobileBreakpoint:768,activeClass:"active",scrolledClass:"scrolled",mobileOpenClass:"mobile-open"};class NavigationManager{constructor(){this.navbar=null;this.mobileToggle=null;this.navLinks=[];this.sections=[];this.currentSection=null;this.isScrolling=false;this.isMobileOpen=false;this.init()}init(){this.cacheElements();this.bindEvents();this.setupSmoothScroll();this.setupActiveSection();this.setupMobileMenu();this.setupScrollSpy();this.setupKeyboardNavigation()}cacheElements(){this.navbar=DOM.select(".navbar");this.mobileToggle=DOM.select(".mobile-toggle");this.navLinks=DOM.selectAll(".nav-link");this.sections=DOM.selectAll("section[id]");this.backToTop=DOM.select(".back-to-top")}bindEvents(){Events.on(window,"scroll",Events.throttle(()=>{this.handleScroll()},16));Events.on(window,"resize",Events.debounce(()=>{this.handleResize()},250));if(this.mobileToggle){Events.on(this.mobileToggle,"click",e=>{e.preventDefault();this.toggleMobileMenu()})}this.navLinks.forEach(link=>{Events.on(link,"click",e=>{this.handleNavClick(e,link)})});if(this.backToTop){Events.on(this.backToTop,"click",e=>{e.preventDefault();this.scrollToTop()})}Events.on(document,"click",e=>{if(this.isMobileOpen&&!this.navbar.contains(e.target)){this.closeMobileMenu()}});Events.on(document,"keydown",e=>{if(e.key==="Escape"&&this.isMobileOpen){this.closeMobileMenu()}})}handleScroll(){const scrollY=window.pageYOffset;if(scrollY>100){DOM.addClass(this.navbar,NAV_CONFIG.scrolledClass)}else{DOM.removeClass(this.navbar,NAV_CONFIG.scrolledClass)}if(!this.isScrolling){this.updateActiveSection()}if(this.backToTop){if(scrollY>500){DOM.addClass(this.backToTop,"show")}else{DOM.removeClass(this.backToTop,"show")}}}handleResize(){const isMobile=window.innerWidth<NAV_CONFIG.mobileBreakpoint;if(!isMobile&&this.isMobileOpen){this.closeMobileMenu()}}setupSmoothScroll(){if(!("scrollBehavior"in document.documentElement.style)){this.enableSmoothScrollPolyfill()}}enableSmoothScrollPolyfill(){const easeInOutQuad=t=>{return t<.5?2*t*t:-1+(4-2*t)*t};this.smoothScrollTo=(target,duration=NAV_CONFIG.scrollDuration)=>{const start=window.pageYOffset;const startTime=performance.now();const animateScroll=currentTime=>{const timeElapsed=currentTime-startTime;const progress=Math.min(timeElapsed/duration,1);const ease=easeInOutQuad(progress);window.scrollTo(0,start+(target-start)*ease);if(progress<1){requestAnimationFrame(animateScroll)}else{this.isScrolling=false}};this.isScrolling=true;requestAnimationFrame(animateScroll)}}handleNavClick(e,link){const href=link.getAttribute("href");if(!href||!href.startsWith("#"))return;e.preventDefault();const targetId=href.substring(1);const targetSection=DOM.select(`#${targetId}`);if(targetSection){this.scrollToSection(targetSection);if(this.isMobileOpen){this.closeMobileMenu()}this.updateURL(href)}}scrollToSection(section){const rect=section.getBoundingClientRect();const scrollTop=window.pageYOffset;const targetPosition=scrollTop+rect.top-NAV_CONFIG.scrollOffset;if(this.smoothScrollTo){this.smoothScrollTo(targetPosition)}else{this.isScrolling=true;window.scrollTo({top:targetPosition,behavior:"smooth"});setTimeout(()=>{this.isScrolling=false},NAV_CONFIG.scrollDuration)}}scrollToTop(){if(this.smoothScrollTo){this.smoothScrollTo(0)}else{window.scrollTo({top:0,behavior:"smooth"})}}setupActiveSection(){this.updateActiveSection()}setupScrollSpy(){const observer=new IntersectionObserver(entries=>{entries.forEach(entry=>{if(entry.isIntersecting){const id=entry.target.id;this.setActiveNavLink(id)}})},{threshold:.3,rootMargin:`-${NAV_CONFIG.scrollOffset}px 0px -50% 0px`});this.sections.forEach(section=>{observer.observe(section)})}updateActiveSection(){const scrollY=window.pageYOffset+NAV_CONFIG.scrollOffset+1;let currentSection=null;this.sections.forEach(section=>{const rect=section.getBoundingClientRect();const sectionTop=window.pageYOffset+rect.top;const sectionBottom=sectionTop+rect.height;if(scrollY>=sectionTop&&scrollY<sectionBottom){currentSection=section.id}});if(currentSection&&currentSection!==this.currentSection){this.setActiveNavLink(currentSection);this.currentSection=currentSection}}setActiveNavLink(sectionId){this.navLinks.forEach(link=>{DOM.removeClass(link,NAV_CONFIG.activeClass);DOM.removeClass(link.parentElement,NAV_CONFIG.activeClass)});const activeLink=DOM.select(`[href="#${sectionId}"]`);if(activeLink){DOM.addClass(activeLink,NAV_CONFIG.activeClass);DOM.addClass(activeLink.parentElement,NAV_CONFIG.activeClass)}}setupMobileMenu(){if(!this.mobileToggle)return;this.createMobileOverlay();this.setupMobileAnimations()}createMobileOverlay(){const overlay=DOM.create("div","mobile-overlay");document.body.appendChild(overlay);Events.on(overlay,"click",()=>{this.closeMobileMenu()});this.mobileOverlay=overlay}setupMobileAnimations(){const navMenu=DOM.select(".nav-menu");if(!navMenu)return;const navItems=DOM.selectAll(".nav-item",navMenu);navItems.forEach((item,index)=>{DOM.setData(item,"index",index)})}toggleMobileMenu(){if(this.isMobileOpen){this.closeMobileMenu()}else{this.openMobileMenu()}}openMobileMenu(){this.isMobileOpen=true;DOM.addClass(this.navbar,NAV_CONFIG.mobileOpenClass);DOM.addClass(document.body,"mobile-menu-open");DOM.addClass(this.mobileOverlay,"show");this.animateMobileMenuItems(true);const firstNavLink=this.navLinks[0];if(firstNavLink){setTimeout(()=>firstNavLink.focus(),300)}}closeMobileMenu(){this.isMobileOpen=false;this.animateMobileMenuItems(false);setTimeout(()=>{DOM.removeClass(this.navbar,NAV_CONFIG.mobileOpenClass);DOM.removeClass(document.body,"mobile-menu-open");DOM.removeClass(this.mobileOverlay,"show")},300)}animateMobileMenuItems(show){const navItems=DOM.selectAll(".nav-item");navItems.forEach((item,index)=>{const delay=show?index*50:(navItems.length-index-1)*50;setTimeout(()=>{if(show){AnimationUtils.slideIn(item,"right",50)}else{AnimationUtils.slideIn(item,"left",50)}},delay)})}setupKeyboardNavigation(){Events.on(document,"keydown",e=>{if(this.isMobileOpen&&e.key==="Tab"){this.handleTabNavigation(e)}if(e.ctrlKey||e.metaKey){switch(e.key){case"Home":e.preventDefault();this.scrollToTop();break}}})}handleTabNavigation(e){const focusableElements=this.navLinks.filter(link=>{return link.offsetParent!==null});const firstElement=focusableElements[0];const lastElement=focusableElements[focusableElements.length-1];if(e.shiftKey){if(document.activeElement===firstElement){e.preventDefault();lastElement.focus()}}else{if(document.activeElement===lastElement){e.preventDefault();firstElement.focus()}}}updateURL(hash){if(history.pushState){const newURL=window.location.pathname+window.location.search+hash;history.pushState(null,null,newURL)}else{window.location.hash=hash}}navigateToSection(sectionId){const section=DOM.select(`#${sectionId}`);if(section){this.scrollToSection(section);this.updateURL(`#${sectionId}`)}}getCurrentSection(){return this.currentSection}getSections(){return this.sections.map(section=>({id:section.id,title:section.querySelector("h1, h2, h3")?.textContent||section.id,element:section}))}createBreadcrumb(){const breadcrumb=DOM.create("nav","breadcrumb");const list=DOM.create("ol","breadcrumb-list");const homeItem=DOM.create("li","breadcrumb-item");const homeLink=DOM.create("a","breadcrumb-link");homeLink.href="#";homeLink.textContent="Inicio";homeItem.appendChild(homeLink);list.appendChild(homeItem);if(this.currentSection){const currentItem=DOM.create("li","breadcrumb-item active");currentItem.textContent=this.getSectionTitle(this.currentSection);list.appendChild(currentItem)}breadcrumb.appendChild(list);return breadcrumb}getSectionTitle(sectionId){const section=DOM.select(`#${sectionId}`);if(section){const heading=section.querySelector("h1, h2, h3");return heading?heading.textContent:sectionId}return sectionId}destroy(){Events.off(window,"scroll");Events.off(window,"resize");if(this.mobileToggle){Events.off(this.mobileToggle,"click")}this.navLinks.forEach(link=>{Events.off(link,"click")});if(this.backToTop){Events.off(this.backToTop,"click")}if(this.mobileOverlay&&this.mobileOverlay.parentNode){this.mobileOverlay.parentNode.removeChild(this.mobileOverlay)}this.navbar=null;this.mobileToggle=null;this.navLinks=[];this.sections=[];this.currentSection=null}}let navigationManager=null;export const initNavigation=()=>{if(document.readyState==="loading"){Events.on(document,"DOMContentLoaded",()=>{navigationManager=new NavigationManager})}else{navigationManager=new NavigationManager}};export const getNavigationManager=()=>navigationManager;export const NavigationUtils={scrollToElement:(element,offset=NAV_CONFIG.scrollOffset)=>{if(!element)return;const rect=element.getBoundingClientRect();const scrollTop=window.pageYOffset;const targetPosition=scrollTop+rect.top-offset;window.scrollTo({top:targetPosition,behavior:"smooth"})},getElementScrollPosition:(element,offset=NAV_CONFIG.scrollOffset)=>{if(!element)return 0;const rect=element.getBoundingClientRect();const scrollTop=window.pageYOffset;return scrollTop+rect.top-offset},isElementInViewport:(element,threshold=.5)=>{if(!element)return false;const rect=element.getBoundingClientRect();const windowHeight=window.innerHeight;const elementHeight=rect.height;const visibleHeight=Math.min(rect.bottom,windowHeight)-Math.max(rect.top,0);const visibilityRatio=visibleHeight/elementHeight;return visibilityRatio>=threshold}};export default{NavigationManager:NavigationManager,NavigationUtils:NavigationUtils,initNavigation:initNavigation,getNavigationManager:getNavigationManager};